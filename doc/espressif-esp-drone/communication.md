<!-- Переведено с https://docs.espressif.com/projects/espressif-esp-drone/en/latest/ -->
<!-- Оригинал: английский | Перевод: русский | Инструмент: Google Translate API -->

# Протоколы связи

[中文]

## Коммуникационная иерархия

| Терминал | Мобильный/ПК | ESP-Дрон |
| --- | --- | --- |
| Прикладной уровень | APP | Прошивка управления полетом |
| Уровень протокола | ЦРТП | ЦРТП |
| Транспортный уровень | UDP | UDP |
| Физический уровень | Wi-Fi STA (Станция) | Точка доступа Wi-Fi (точка доступа) |

## Wi-Fi-связь

### Производительность Wi-Fi

Производительность Wi-Fi ESP32

| Элемент | Параметр |
| --- | --- |
| Режим | Режим STA, режим AP, режим STA+AP |
| Протокол | IEEE 802.11b/g/n и 802.11 LR (Эспрессиф). Поддержка переключения программного обеспечения |
| Безопасность | WPA, WPA2, WPA2-предприятие, WPS |
| Основная особенность | AMPDU, HT40, качество обслуживания |
| Поддерживаемое расстояние | 1 км по Эксклюзивному соглашению Espressif |
| Скорость передачи | Пропускная способность TCP 20 Мбит/с, UDP 30 Мбит/с |

Остальные параметры см. в списке функций Wi-Fi ESP32.

ESP32-S2 Производительность Wi-Fi

| Элемент | Параметр |
| --- | --- |
| Режим | Режим STA, режим AP, режим STA+AP |
| Протокол | ИЭЭЭ 802.11б/г/н. Поддержка переключения программного обеспечения |
| Безопасность | WPA, WPA2, WPA2-предприятие, WPS |
| Основная особенность | AMPDU, HT40, качество обслуживания |
| Поддерживаемое расстояние | 1 км по Эксклюзивному соглашению Espressif |
| Скорость передачи | Пропускная способность TCP 20 Мбит/с, UDP 30 Мбит/с |

Остальные параметры см. в списке функций Wi-Fi ESP32-S2.

### Платформа программирования Wi-Fi

Платформа программирования Wi-Fi на основе ESP-IDF

![Wi-Fi Programming Example](https://img-blog.csdnimg.cn/20200423173923300.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIwNTE1NDYx,size_16,color_FFFFFF,t_70#pic_center)

Пример программирования Wi-Fi

Общий процесс программирования

- На уровне приложения вызовите API драйвера Wi-Fi для инициализации Wi-Fi.
- Драйвер Wi-Fi прозрачен для разработчиков. Когда происходит событие, драйвер Wi-Fi отправляет событие в цикл событий по умолчанию. Приложения могут писать и регистрировать программы-дескрипторы по требованию.
- Компонент сетевого интерфейса esp_netif по умолчанию предоставляет программу-дескриптор, связанную с событием драйвера Wi-Fi. Например, когда ESP32 работает как точка доступа и пользователь подключается к этой точке доступа, esp_netif автоматически запустит службу DHCP.

Подробную информацию об использовании см. в коде \comComponents\drivers\general\wifi\wifi_esp32.c.

Примечание

Перед инициализацией Wi-Fi используйте WIFI_INIT_CONFIG_DEFAULT, чтобы получить структуру конфигурации инициализации, и сначала настройте эту структуру, а затем запустите инициализацию. Помните о проблемах, вызванных неинициализированными членами структуры, и обращайте особое внимание на эту проблему при добавлении новых членов структуры в ESP-IDF во время обновления.

Рабочий процесс режима точки доступа

![Sample Wi-Fi Event Scenarios in AP Mode](https://img-blog.csdnimg.cn/2020042622523887.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIwNTE1NDYx,size_16,color_FFFFFF,t_70#pic_center)

Примеры сценариев событий Wi-Fi в режиме точки доступа

### Увеличьте расстояние связи Wi-Fi

Перейдите в Component config>>PHY>>Max WiFi TX power (dBm) и обновите Max WiFi TX power до 20 . Эта конфигурация увеличивает усиление PHY и расстояние связи Wi-Fi.

## UDP-коммуникация

### UDP-порт

| App | Направление | ESP-Дрон |
| --- | --- | --- |
| 192.168.43.42::2399 | Передача/Прием | 192.168.43.42::2390 |

### Структура UDP-пакета

```
/* Frame format:
 * +=============+-----+-----+
 * | CRTP                      |   CKSUM   |
 * +=============+-----+-----+
 */

```

- Пакет, передаваемый по UDP: CRTP + проверочная информация.
- CRTP: согласно определению структуры пакета CRTP, он содержит заголовок и данные, как подробно описано в разделе «Протокол CRTP».
- CKSUM: информация о проверке. Его размер составляет 1 байт, и эта CKSUM увеличивается на байт пакета CRTP.

Метод расчета CKSUM

```
#take python as an example: Calculate the raw cksum and add it to the end of the packet
 raw = (pk.header,) + pk.datat
 cksum = 0
 for i in raw:
        cksum += i
 cksum %= 256
 raw = raw + (cksum,)

```

## CRTP-протокол

Проект ESP-Drone продолжает протокол CRTP, используемый проектом Crazyflie для отправки инструкций по полету, возврата данных о полете, настройки параметров и т. д.

CRTP реализует конструкцию без сохранения состояния, не требующую этапа установления связи. Любую команду можно отправить в любое время, но для некоторых команд log/param/mem необходимо загрузить TOC (каталог), чтобы помочь хосту правильно отправить информацию. Реализованный Python API (cflib) может загружать TOC param/log/mem, чтобы гарантировать доступность всех функций.

### Структура пакета CRTP

32-байтовый пакет CRTP содержит один байт заголовка и 31 байт полезной нагрузки. Заголовок записывает информацию о портах (4 бита), каналах (2 бита) и зарезервированных битах (2 бита).

```
  7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+
|     Port      |  Res. | Chan. |
+---+---+---+---+---+---+---+---+
|            DATA 0             |
+---+---+---+---+---+---+---+---+
:   :   :   :   :   :   :   :   :
+---+---+---+---+---+---+---+---+
|            DATA 30            |
+---+---+---+---+---+---+---+---+

```

| Поле | Байт | Bit | Описание |
| --- | --- | --- | --- |
| Заголовок | 0 | 0 ~ 1 | Целевой канал данных |
|  | 0 | 2 ~ 3 | Зарезервировано для транспортного уровня |
|  | 0 | 4 ~ 7 | Целевой порт данных |
| Данные | 1 ~ 31 | 0 ~ 7 | Данные в этом пакете |

### Распределение портов

| Порт | Цель | Цель |
| --- | --- | --- |
| 0 | Консоль | Прочитайте текст консоли, который выводится на консоль Crazyflie, с помощью consoleprintf. |
| 2 | Параметры | Получить/установить параметры из Crazyflie. Параметры определяются с помощью макроса в исходном коде Crazyflie. |
| 3 | Командир | Отправка контрольных точек для регуляторов крена/тангажа/рысканья/тяги. |
| 4 | Доступ к памяти | Доступ к энергонезависимой памяти, такой как 1-wire и I2C (поддерживается только для Crazyflie 2.0) |
| 5 | Регистрация данных | Настройте блоки журналов с переменными, которые будут отправлены обратно в Crazyflie в указанный период. Переменные журнала определяются с помощью макроса в исходном коде Crazyflie. |
| 6 | Локализация | Пакеты, связанные с локализацией |
| 7 | Общая уставка | Позволяет отправлять заданное значение и режимы управления. |
| 13 | Платформа | Используется для управления различными платформами, например, отладки и отключения питания. |
| 14 | Отладка на стороне клиента | Отладка пользовательского интерфейса существует только в API Crazyflie Python, а не в самом Crazyflie. |
| 15 | Слой связи | Используется для управления и запроса канала связи. |

Большинство модулей в прошивке, подключаемых к порту, реализованы как задачи. Если входящий пакет CRTP доставляется в очередь сообщений, задача блокируется в очереди. При запуске каждая задача и другие модули должны быть зарегистрированы для заранее определенного порта на уровне канала связи.

Подробности использования каждого порта можно найти на странице CRTP-Communate with Crazyflie.

### Поддерживаемый пакет по протоколу CRTP

cflib — это пакет Python, поддерживаемый протоколом CRTP, который предоставляет интерфейс прикладного уровня для протоколов связи, которые можно использовать для создания верхнего ПК для связи с квадрокоптерами Crazyflie и Crazyflie 2.0.
Каждый компонент прошивки, использующий протокол CRTP, имеет соответствующий ему скрипт в cflib.

- Репозиторий исходного кода: madflie-lib-python.
- Репозиторий cflib специально для ESP-Drone: qljz1993/crazyflie-lib-python. Пожалуйста, оформляйте заказ в филиале Esplane.

## Разработка приложений на основе протокола CRTP

### Примеры для различных платформ

- madflie2-ios-клиент
- madflie2-windows-uap-клиент
- madflie-android-клиент
- Руководство пользователя на Android
- Руководство по разработке на Android

### cfclient

cfclient — это верхний ПК для проекта Crazeflie, который полностью реализовал функции, определенные в протоколе CRTP, и ускоряет процесс отладки дрона. Проект ESP-Drone адаптирует и настраивает верхний ПК в соответствии с функциональными потребностями дизайна.

![Cfclient Control Interface](_images/cfclient.png)

Интерфейс управления Cfclient

Подробную информацию о cfclient можно найти в cfclient.
